import React from "react";
import { AdministratorNavBar } from "Components/NavBar";
import { SearchInput } from "Components/SearchInput";
import { useForm } from "react-hook-form";
import { yupResolver } from "@hookform/resolvers/yup";
import * as yup from "yup";
import { InteractiveButton } from "Components/InteractiveButton";
import { IoFilterCircle } from "react-icons/io5";
import { FaPlus } from "react-icons/fa6";
import { MkdListTable } from "Components/MkdListTable";
import { PaginationBar } from "Components/PaginationBar";
import { GlobalContext, showToast } from "Context/Global";
import { useNavigate } from "react-router";
import {
  AdministratorAddSkillModal,
  AdministratorEditSkillModal,
} from "Components/AdministratorSkill";
import { supabase } from "Src/supabase";
import { getSkillStatusName, getSkillType } from "Utils/utils";
import moment from "moment";

const columns = [
  {
    header: "Skill Name",
    accessor: "name",
    isSorted: false,
    isSortedDesc: false,
    mappingExist: false,
    mappings: {},
  },

  {
    header: "Category",
    accessor: "category_name",
    isSorted: false,
    isSortedDesc: false,
    mappingExist: false,
    mappings: {},
  },
  {
    header: "Type",
    accessor: "type_name",
    isSorted: false,
    isSortedDesc: false,
    mappingExist: false,
    mappings: {},
  },

  {
    header: "Levels Tagged",
    accessor: "level_tagged",
    isSorted: false,
    isSortedDesc: false,
    mappingExist: false,

    mappings: {},
  },
  {
    header: "Status",
    accessor: "status_name",
    isSorted: false,
    isSortedDesc: false,
    mappingExist: false,
    showDot: true,
    mappings: {},
  },

  {
    header: "Last Modified",
    accessor: "updated_at",
    isSorted: false,
    isSortedDesc: false,
    mappingExist: false,
    mappings: {},
  },

  {
    header: "Action",
    accessor: "",
  },
];

const data = [
  {
    name: "Freestyle Kick",
    category: "Swimming",
    type: "Technical",
    level_tagged: 2,
    status: "Active",
    updated_at: "Aug 01, 2025 10:15 am",
  },
  {
    name: "Backstroke Turn",
    category: "Swimming",
    type: "Technical",
    level_tagged: 3,
    status: "Active",
    updated_at: "Aug 03, 2025 02:45 pm",
  },
  {
    name: "Butterfly Stroke",
    category: "Swimming",
    type: "Performance",
    level_tagged: 1,
    status: "Inactive",
    updated_at: "Aug 05, 2025 09:20 am",
  },
  {
    name: "Endurance Swim",
    category: "Conditioning",
    type: "Stamina",
    level_tagged: 4,
    status: "Active",
    updated_at: "Aug 07, 2025 04:30 pm",
  },
  {
    name: "Breath Control",
    category: "Breathing",
    type: "Skill",
    level_tagged: 2,
    status: "Active",
    updated_at: "Aug 08, 2025 11:10 am",
  },
  {
    name: "Treading Water",
    category: "Survival",
    type: "Basic",
    level_tagged: 1,
    status: "Active",
    updated_at: "Aug 10, 2025 01:55 pm",
  },
  {
    name: "Dive Entry",
    category: "Diving",
    type: "Technical",
    level_tagged: 2,
    status: "Inactive",
    updated_at: "Aug 12, 2025 03:40 pm",
  },
  {
    name: "Flip Turn",
    category: "Swimming",
    type: "Technical",
    level_tagged: 3,
    status: "Active",
    updated_at: "Aug 14, 2025 08:25 am",
  },
  {
    name: "Underwater Dolphin Kick",
    category: "Swimming",
    type: "Performance",
    level_tagged: 2,
    status: "Active",
    updated_at: "Aug 17, 2025 05:50 pm",
  },
  {
    name: "Relay Exchange",
    category: "Teamwork",
    type: "Coordination",
    level_tagged: 3,
    status: "Active",
    updated_at: "Aug 20, 2025 12:40 pm",
  },
];

const AdministratorSkillListPage = () => {
  const [pageSize, setPageSize] = React.useState(10);
  const [pageCount, setPageCount] = React.useState(0);
  const [totalSkills, setTotalSkils] = React.useState(0);
  const [currentPage, setPage] = React.useState(0);
  const [canPreviousPage, setCanPreviousPage] = React.useState(false);
  const [canNextPage, setCanNextPage] = React.useState(false);
  const [currentTableData, setCurrentTableData] = React.useState(data);
  const [showDeleteModal, setShowDeleteModal] = React.useState(false);
  const [deleteLoading, setDeleteLoading] = React.useState(false);
  const [loading, setLoading] = React.useState(false);
  const [isAddSkillModalOpen, setAddSkillModalOpen] = React.useState(false);
  const [editingSkillId, setEditingSkillId] = React.useState(null);

  const [filter, setFilters] = React.useState({
    name: "",
    categories: [],
    types: [],
    updatedAfter: "",
    updatedBefore: "",
    ids: [],
  });

  const { dispatch: globalDispatch } = React.useContext(GlobalContext);
  const navigate = useNavigate();

  const schema = yup
    .object({
      searchText: yup.string(),
    })
    .required();

  const {
    register,
    handleSubmit,
    setError,
    formState: { errors },
  } = useForm({
    resolver: yupResolver(schema),
  });

  const getData = async (page = 1, limit = 10, filters = {}) => {
    setLoading(true);

    const from = (page - 1) * limit;
    const to = from + limit - 1;

    let query = supabase
      .from("skill")
      // .select("*, skill_category(name)", { count: "exact" }) // join category
      .select("*,skill_category ( id, name ),organization ( id, name )")
      .range(from, to)
      .order("updated_at", { ascending: false });

    // ðŸ” Apply filters
    if (filters?.name) {
      query = query.ilike("name", `%${filters?.name}%`);
    }
    if (filters?.categories?.length) {
      query = query.in("category_id", filters?.categories);
    }
    if (filters?.types?.length) {
      query = query.in("type", filters?.types);
    }
    if (filters?.statuses?.length) {
      query = query.in("status", filters?.statuses);
    }
    if (filters?.updatedAfter) {
      query = query.gte("updated_at", filters?.updatedAfter);
    }
    if (filters?.updatedBefore) {
      query = query.lte("updated_at", filters?.updatedBefore);
    }
    if (filters?.ids?.length) {
      query = query.in("id", filters?.ids);
    }

    const { data, error, count } = await query;

    if (error) {
      console.error("Error fetching skills:", error);
    } else {
      const dataModified = data?.map((item) => ({
        ...item,
        category_name: item?.skill_category?.name,
        type_name: getSkillType(item?.type),
        status_name: getSkillStatusName(item?.status),
        updated_at: moment(item?.updated_at).format("MMM DD, YYYY h:mmA"),
      }));
      setCurrentTableData(dataModified || []);
      setTotalSkils(count || 0);

      // calculate total pages
      const totalPages = Math.ceil((count || 0) / limit);
      setPageCount(totalPages);
      setPageSize(limit);
      setPage(page);
    }

    setLoading(false);
  };

  const onSubmit = async (data) => {
    console.log(data);
  };

  const handleDeleteItem = async (id) => {
    setDeleteLoading(true);
    try {
      const { error, data } = await supabase
        .from("skill")
        .delete()
        .eq("id", id);

      console.log(error);
      console.log(data);
      if (error) {
        showToast(globalDispatch, "Failed to delete the skill.");
      }
      getData(currentPage, pageSize, filter);
    } catch (error) {
      console.log(error?.message);
      showToast(
        globalDispatch,
        error?.message || "Failed to delete the skill.",
        4000,
        "error"
      );
    }
    setDeleteLoading(false);
    setShowDeleteModal(false);
  };

  React.useEffect(() => {
    globalDispatch({
      type: "SETPATH",
      payload: {
        path: "skill",
      },
    });
    getData(1, 10);
  }, []);

  return (
    <div className="">
      <AdministratorNavBar />

      <div className="px-7">
        {/* Bottom search bar */}
        <div className="flex mb-7 items-center gap-5 justify-between">
          <div className="flex  flex-1 max-w-xl items-center gap-5">
            <form className="flex-1 " onSubmit={handleSubmit(onSubmit)}>
              <SearchInput
                errors={errors}
                register={register}
                name={"searchText"}
                placeholder={"Search by Level Name"}
              />
            </form>

            <InteractiveButton type={"button"} isSecondaryBtn={true}>
              <p className="flex items-center gap-2">
                <span>Filter</span>
                <IoFilterCircle className="" size={25} />
              </p>
            </InteractiveButton>
          </div>

          <InteractiveButton
            className={"!px-10"}
            type={"button"}
            onClick={() => setAddSkillModalOpen(true)}
          >
            <span className="flex items-center gap-3">
              {" "}
              <FaPlus />
              <span>New Skill</span>
            </span>
          </InteractiveButton>
        </div>

        {/* table */}
        <MkdListTable
          columns={columns}
          tableRole={"administrator"}
          table={"level"}
          actionId={"id"}
          deleteItem={handleDeleteItem}
          loading={loading}
          deleteLoading={deleteLoading}
          showDeleteModal={showDeleteModal}
          currentTableData={currentTableData}
          setShowDeleteModal={setShowDeleteModal}
          setCurrentTableData={setCurrentTableData}
          actions={{ delete: true, edit: true }}
          handleEditFunction={(id) => setEditingSkillId(id)}
        />

        <PaginationBar
          currentPage={currentPage}
          pageCount={pageCount}
          pageSize={pageSize}
          canPreviousPage={canPreviousPage}
          canNextPage={canNextPage}
          updatePageSize={() => {}}
          previousPage={() => {}}
          nextPage={() => {}}
          // updatePageSize={updatePageSize}
          // previousPage={previousPage}
          // nextPage={nextPage}
        />
      </div>

      <AdministratorAddSkillModal
        setShowModal={setAddSkillModalOpen}
        showModal={isAddSkillModalOpen}
        refetch={getData}
      />

      <AdministratorEditSkillModal
        setShowModal={() => setEditingSkillId(null)}
        showModal={!!editingSkillId}
        skillId={editingSkillId}
        refetch={getData}
      />
    </div>
  );
};

export default AdministratorSkillListPage;
